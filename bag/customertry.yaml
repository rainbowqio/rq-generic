version: 2.1

parameters:
  from_api:
    # TODO: Rename from_api to something like trigger_tests
    type: boolean
    default: false
  deploy_mt_service_to_dev:
    type: boolean
    default: false
  service_name:
    # service_name is the name of the mt service to deploy
    type: string
    default: ""
  service_version:
    # service_version is the version of the mt service to deploy
    type: string
    default: ""

##
# Initialize the Blameless CICD Orb
##
orbs:
  blameless-cicd: blamelesstest/blameless-cicd@dev:v1.0

##
# Executors
##
default_job_args: &default_job_args
  primary_image: gcr.io/blameless-185322/blameless-ci
  primary_tag: 3.11-3
  context: ci_builds

default_executor: &default_executor
  docker:
    - image: gcr.io/blameless-185322/blameless-ci:3.11-3
      auth:
        username: _json_key
        password: $GOOGLE_SA_KEY

e2e_test_executor: &e2e_test_executor
  docker:
    - image: gcr.io/blameless-185322/cypress:12
      auth:
        username: _json_key
        password: $GOOGLE_SA_KEY

###
#  Common commands used throughout this config
###

#
# Command to establish connection to cluster no private network
# and deploy Blameless
#
deploy_private: &deploy_private
  <<: *default_executor
  steps:
    - checkout
    - blameless-cicd/configure-gcloud
    - blameless-cicd/configure-kube-access:
        gcp_kms_key: ${KMS_DEPLOY_KEY}
        kube_config: ./deployment/config/kube-config.json
        ssh_config: ./deployment/config/ssh-config.json
        ssh_key: ./deployment/config/id_rsa_circleci.json
        provider: ${PROVIDER}
        environment: ${CLUSTER_ENV}
        region: ${CLUSTER_REGION}
        cluster_ip: ${CLUSTER_IP}
        cluster_context: ${KUBE_CLUSTER_ENTRY}
    - run:
        name: Deploy to cluster
        command: |
          # ToDo(KMG) BLAME-3477: Remove the -D parameter once we are on Helm 3
          # The problem here is that the increased parallelism in the circleci pipelines
          # has led to a situation where parallel deploys overwhelm the Helm tiller.
          ./deployment/scripts/release_cluster.sh -C ${KUBE_CLUSTER_ENTRY} \
                                                  -V ${INSTANCE_VALUES_DIR} \
                                                  -n ${RELEASE_NAME} \
                                                  -w ${BLAMELESS_CIRCLECI_WEBHOOK} \
                                                  -j ${CIRCLE_BUILD_NUM} \
                                                  -u ${CIRCLE_BUILD_URL} \
                                                  -d ./deployment/config/deployment.json \
                                                  -D 240

#
# Command to establish connection to cluster on private network
# and deploy multitenant services
#
deploy_private_multitenant_services: &deploy_private_multitenant_services
  <<: *default_executor
  steps:
    - checkout
    - blameless-cicd/configure-gcloud
    - blameless-cicd/configure-kube-access:
        gcp_kms_key: ${KMS_DEPLOY_KEY}
        kube_config: ./deployment/config/kube-config.json
        ssh_config: ./deployment/config/ssh-config.json
        ssh_key: ./deployment/config/id_rsa_circleci.json
        provider: ${PROVIDER}
        environment: ${CLUSTER_ENV}
        region: ${CLUSTER_REGION}
        cluster_ip: ${CLUSTER_IP}
        cluster_context: ${KUBE_CLUSTER_ENTRY}
    - when:
        condition: << pipeline.parameters.deploy_mt_service_to_dev >>
        steps:
          - run:
              name: Deploy a multitenant service to mt cluster
              command: |
                ./deployment/scripts/deploy_mt_service.sh   -C ${KUBE_CLUSTER_ENTRY} \
                                                            -L ${INSTANCE_VALUES_DIR} \
                                                            -s << pipeline.parameters.service_name >> \
                                                            -v << pipeline.parameters.service_version >>
#
# Command to establish connection to cluster on private network
# and deploy multitenant platform shared resources
#
deploy_private_multitenant_platform: &deploy_private_multitenant_platform
  <<: *default_executor
  steps:
    - checkout
    - blameless-cicd/configure-gcloud
    - blameless-cicd/configure-kube-access:
        gcp_kms_key: ${KMS_DEPLOY_KEY}
        kube_config: ./deployment/config/kube-config.json
        ssh_config: ./deployment/config/ssh-config.json
        ssh_key: ./deployment/config/id_rsa_circleci.json
        provider: ${PROVIDER}
        environment: ${CLUSTER_ENV}
        region: ${CLUSTER_REGION}
        cluster_ip: ${CLUSTER_IP}
        cluster_context: ${KUBE_CLUSTER_ENTRY}
    - run:
        name: Deploy shared multitenant resources to mt cluster
        command: |
          ./deployment/scripts/deploy_mt_platform.sh  -C ${KUBE_CLUSTER_ENTRY} \
                                                      -V ${INSTANCE_VALUES_DIR}
                                                      -d ./deployment/config/mt-platform-deployment.json

##
# Commands used to establish ordering between jobs
##
dev_wf_defaults: &dev_wf_defaults
  requires:
    - test_helm_versions
  filters:
    branches:
      only:
        - master
  context: ci_builds

hold_wf_defaults: &hold_wf_defaults
  requires:
    - blamelesscre
    - hold-blameless
  type: approval
  filters:
    branches:
      only:
        - master

hold_ha_wf_defaults: &hold_ha_wf_defaults
  requires:
    - blamelesscre
    - hold
  type: approval
  filters:
    branches:
      only:
        - master

prod_wf_defaults: &prod_wf_defaults
  requires:
    - hold
  filters:
    branches:
      only: master
  context: ci_builds

prod_wf_defaults_ha: &prod_wf_defaults_ha
  requires:
    - hold-ha
  filters:
    branches:
      only: master
  context: ci_builds

hold_cre_wf_defaults: &hold_cre_wf_defaults
  requires:
    # Add this back in when the tests are stable
    # - test-check
    - blamelessdev
    - test_helm_versions
  type: approval
  filters:
    branches:
      only:
        - master

hold_blameless_wf_defaults: &hold_blameless_wf_defaults
  requires:
    - blamelesscre
  type: approval
  filters:
    branches:
      only:
        - master

cre_wf_defaults: &cre_wf_defaults
  requires:
    - hold-cre
  filters:
    branches:
      only:
        - master
  context: ci_builds

blameless_wf_defaults: &blameless_wf_defaults
  requires:
    - hold-blameless
  filters:
    branches:
      only:
        - master
  context: ci_builds

###
# Job definitions used in the workflows for this config
###
jobs:
  test_helm_versions: &test_helm_versions
    <<: *default_executor
    steps:
      - checkout
      - blameless-cicd/configure-gcloud
      - run:
          name: Verifying whether charts are valid and each version exists
          command: ./deployment/scripts/check_if_chart_exist.sh -d ./deployment/config/deployment.json

  # Performance Tests
  # TODO: Update this to use new dedicated cluster
  # sitespeed-perf-test: &sitespeed-perf-test
  #   <<: *default_executor
  #   resource_class: xlarge
  #   working_directory: ~/fe-perf
  #   steps:
  #     - checkout
  #     - setup_remote_docker:
  #         version: 18.09.3
  #     - blameless-cicd/configure-gcloud
  #     - blameless-cicd/decrypt-secret-gcp:
  #         bucket_name: e2eetst-secrets
  #         object_name: e2e-test-deploy-key-encrypted
  #         gcp_kms_key: blameless-185322/locations/global/keyRings/e2etests/cryptoKeys/e2e-test-deploy-key
  #         outfile: /tmp/e2e-deploy-key
  #     - run:
  #         name: Get fe performance Tests
  #         command: |
  #           mkdir -p ~/.ssh
  #           echo -e "Host github.com\nStrictHostKeyChecking no\nUser git\nIdentityFile /tmp/e2e-deploy-key" > ~/.ssh/config
  #           git clone git@github.com:blamelesshq/fe-performance.git
  #     - attach_workspace:
  #         at: /tmp
  #     - run:
  #         <<: *get_allocated_instance
  #         working_directory: /tmp
  #     - run:
  #         name: Get FE test config
  #         command: |
  #           sops --decrypt --gcp-kms ${KMS_GITHUB_CONF_KEY} ./test-automation/config/fe-performance/${EPHEMERAL_HOST}-config.json > ./sitespeed-config.json
  #     # No traffic shaping with performance budget
  #     - run:
  #         name: Run sitespeed
  #         command: |
  #           SHOWCASE_E2E_RESULT=`cat /tmp/showcase-test-results/showcase_test_results`
  #           if [[  ${SHOWCASE_E2E_RESULT} == "SUCCESS" ]]; then
  #             echo "Tests were successfully executed, continuing..."
  #           else
  #             echo "Showcase E2E result: ${SHOWCASE_E2E_RESULT}  Exiting job..."
  #             [ -d performance-test-results ] || mkdir performance-test-results
  #             echo "NOT_RUN" >> ./performance-test-results/performance_test_results
  #             exit 0
  #           fi
  #           docker create --name sitespeed.io sitespeedio/sitespeed.io:8.12.0-plus1 --config sitespeed-config.json \
  #             tests/performance-test.js --multi  --budget.configPath sitespeed_budget_circle.json
  #           docker cp sitespeed-config.json sitespeed.io:/sitespeed.io/
  #           docker cp fe-performance/sitespeed_budget_circle.json sitespeed.io:/sitespeed.io/
  #           docker cp fe-performance/tests/ sitespeed.io:/sitespeed.io/
  #           docker start -a sitespeed.io || RET=$?
  #           if [[  ${RET} != 0  ]]; then
  #               echo "Performance Tests failed"
  #               [ -d performance-test-results ] || mkdir performance-test-results
  #               echo "FAILED" >> ./performance-test-results/performance_test_results
  #           else
  #               [ -d performance-test-results ] || mkdir performance-test-results
  #               echo "SUCCESS" >> ./performance-test-results/performance_test_results
  #           fi
  #     - persist_to_workspace:
  #         root: .
  #         paths:
  #           - performance-test-results

  # Multitenant deploys
  # TODO: Delete this old deployment kevin made:
  multitenant:
    environment:
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_dev-us-central1-private-multitenant
      INSTANCE_VALUES_DIR: gke_dev-us-central1-private-multitenant_blamelessdev
      CLUSTER_ENV: dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private

  multitenant-dev:
    environment:
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_mt-dev-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_mt-dev-us-central1-private-a
      CLUSTER_ENV: mt-dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.3.2
      CLUSTER_PORT: 1337
    <<: *deploy_private_multitenant_platform

  multitenant-service-dev:
    environment:
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_mt-dev-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_mt-dev-us-central1-private-a
      CLUSTER_ENV: mt-dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.3.2
      CLUSTER_PORT: 1337
    <<: *deploy_private_multitenant_services

  # Instance deploy jobs
  blameless:
    environment:
      RELEASE_NAME: "blameless"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_blameless
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  blamelesscre:
    environment:
      RELEASE_NAME: "blamelesscre"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_blamelesscre
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  blamelessdemo:
    environment:
      RELEASE_NAME: "blamelessdemo"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_blamelessdemo
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  blamelesstrial:
    environment:
      RELEASE_NAME: "blamelesstrial"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-c
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-c_blamelesstrial
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.4.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  blamelessdev:
    environment:
      RELEASE_NAME: "blamelessdev"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_dev-us-central1-private-multitenant
      INSTANCE_VALUES_DIR: gke_dev-us-central1-private-multitenant_blamelessdev
      CLUSTER_ENV: dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  checkr:
    environment:
      RELEASE_NAME: "checkr"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_checkr
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  iterable:
    environment:
      RELEASE_NAME: "iterable"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_iterable
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  masterclass:
    environment:
      RELEASE_NAME: "masterclass"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_masterclass
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  packet:
    environment:
      RELEASE_NAME: "packet"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_packet
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  procore:
    environment:
      RELEASE_NAME: "procore"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_procore
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  platform9:
    environment:
      RELEASE_NAME: "platform9"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_platform9
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  tenable:
    environment:
      RELEASE_NAME: "tenable"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-tenable
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-singletenant_tenable
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.1.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  homedepot:
    environment:
      RELEASE_NAME: "homedepot"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_homedepot
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  fox:
    environment:
      RELEASE_NAME: "fox"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_fox
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  eventbrite:
    environment:
      RELEASE_NAME: "eventbrite"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_eventbrite
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  underarmour:
    environment:
      RELEASE_NAME: "underarmour"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_underarmour
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  datarobot:
    environment:
      RELEASE_NAME: "datarobot"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_datarobot
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  mambu:
    environment:
      RELEASE_NAME: "mambu"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_mambu
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  addepar:
    environment:
      RELEASE_NAME: "addepar"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-c
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-c_addepar
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.4.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  postmates:
    environment:
      RELEASE_NAME: "postmates"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_postmates
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  earnin:
    environment:
      RELEASE_NAME: "earnin"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-c
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-c_earnin
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.4.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  flywire:
    environment:
      RELEASE_NAME: "flywire"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:eu-central-1:696025759092:cluster/prod-eu-central-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-eu-central-1-private-mt_flywire
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: eu-central-1
      CLUSTER_IP: 981077BB720A2E4E01801AA588F4D72D.gr7.eu-central-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  demo:
    environment:
      RELEASE_NAME: "demo"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:us-west-2:696025759092:cluster/prod-us-west-2-private-mt
      INSTANCE_VALUES_DIR: eks_prod-us-west-2-private-multitenant_demo
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: us-west-2
      CLUSTER_IP: C55764ADEB57080288FDC7D6F2557EB1.sk1.us-west-2.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  acs:
    environment:
      RELEASE_NAME: "acs"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:us-west-2:696025759092:cluster/prod-us-west-2-private-mt
      INSTANCE_VALUES_DIR: eks_prod-us-west-2-private-multitenant_acs
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: us-west-2
      CLUSTER_IP: C55764ADEB57080288FDC7D6F2557EB1.sk1.us-west-2.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  labelbox:
    environment:
      RELEASE_NAME: "labelbox"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_labelbox
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  missionlane:
    environment:
      RELEASE_NAME: "missionlane"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:us-west-2:696025759092:cluster/prod-us-west-2-private-mt
      INSTANCE_VALUES_DIR: eks_prod-us-west-2-private-multitenant_missionlane
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: us-west-2
      CLUSTER_IP: C55764ADEB57080288FDC7D6F2557EB1.sk1.us-west-2.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  citrix:
    environment:
      RELEASE_NAME: "citrix"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:us-east-2:696025759092:cluster/prod-us-east-2-private-mt
      INSTANCE_VALUES_DIR: eks_prod-us-east-2-private-multitenant_citrix
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: us-east-2
      CLUSTER_IP: ED1A37EC6382AC8EA79910D29169FADC.sk1.us-east-2.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  mercari-sandbox:
    environment:
      RELEASE_NAME: "mercari-sandbox"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:ap-northeast-1:696025759092:cluster/prod-ap-northeast-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-ap-northeast-1-private-multitenant_mercari-sandbox
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: ap-northeast-1
      CLUSTER_IP: 5703BBB10EC31F749A4C43A28471014C.sk1.ap-northeast-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  mercari:
    environment:
      RELEASE_NAME: "mercari"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:ap-northeast-1:696025759092:cluster/prod-ap-northeast-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-ap-northeast-1-private-mt_mercari
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: ap-northeast-1
      CLUSTER_IP: 5703BBB10EC31F749A4C43A28471014C.sk1.ap-northeast-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  vital:
    environment:
      RELEASE_NAME: "vital"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:ap-northeast-1:696025759092:cluster/prod-ap-northeast-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-ap-northeast-1-private-mt_vital
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: ap-northeast-1
      CLUSTER_IP: 5703BBB10EC31F749A4C43A28471014C.sk1.ap-northeast-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  gojek:
    environment:
      RELEASE_NAME: "gojek"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:ap-northeast-1:696025759092:cluster/prod-ap-northeast-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-ap-northeast-1-private-mt_gojek
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: ap-northeast-1
      CLUSTER_IP: 5703BBB10EC31F749A4C43A28471014C.sk1.ap-northeast-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  allegro:
    environment:
      RELEASE_NAME: "allegro"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:eu-central-1:696025759092:cluster/prod-eu-central-1-private-mt
      INSTANCE_VALUES_DIR: eks_prod-eu-central-1-private-multitenant_allegro
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: eu-central-1
      CLUSTER_IP: 981077BB720A2E4E01801AA588F4D72D.gr7.eu-central-1.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  greenlight:
    environment:
      RELEASE_NAME: "greenlight"
      KUBE_CLUSTER_ENTRY: arn:aws:eks:us-east-2:696025759092:cluster/prod-us-east-2-private-mt
      INSTANCE_VALUES_DIR: eks_prod-us-east-2-private-multitenant_greenlight
      IS_AWS: true
      CLUSTER_ENV: prod
      PROVIDER: aws
      CLUSTER_REGION: us-east-2
      CLUSTER_IP: ED1A37EC6382AC8EA79910D29169FADC.sk1.us-east-2.eks.amazonaws.com
      CLUSTER_PORT: 1337
    <<: *deploy_private
  gremlin:
    environment:
      RELEASE_NAME: "gremlin"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_gremlin
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  zapier:
    environment:
      RELEASE_NAME: "zapier"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_zapier
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  inloco:
    environment:
      RELEASE_NAME: "inloco"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_inloco
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  cruise:
    environment:
      RELEASE_NAME: "cruise"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_cruise
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  mux:
    environment:
      RELEASE_NAME: "mux"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-multitenant_mux
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  flatiron:
    environment:
      RELEASE_NAME: "flatiron"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_flatiron
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  ticketmaster:
    environment:
      RELEASE_NAME: "ticketmaster"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_ticketmaster
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  hashicorp:
    environment:
      RELEASE_NAME: "hashicorp"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_hashicorp
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  revops:
    environment:
      RELEASE_NAME: "revops"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_revops
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  zoopla:
    environment:
      RELEASE_NAME: "zoopla"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_zoopla
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  fast:
    environment:
      RELEASE_NAME: "fast"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_fast
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  hitachisolutions:
    environment:
      RELEASE_NAME: "hitachisolutions"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-a_hitachisolutions
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  crowdstrike:
    environment:
      RELEASE_NAME: "crowdstrike"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_crowdstrike
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  markley:
    environment:
      RELEASE_NAME: "markley"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_markley
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  paymentsense:
    environment:
      RELEASE_NAME: "paymentsense"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_paymentsense
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  cultureamp:
    environment:
      RELEASE_NAME: "cultureamp"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_cultureamp
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  marqeta:
    environment:
      RELEASE_NAME: "marqeta"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_marqeta
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  twitch:
    environment:
      RELEASE_NAME: "twitch"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_twitch
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  lntinfotech:
    environment:
      RELEASE_NAME: "lntinfotech"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_lntinfotech
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  petalcard:
    environment:
      RELEASE_NAME: "petalcard"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_petalcard
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  paloaltonetworks:
    environment:
      RELEASE_NAME: "paloaltonetworks"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_paloaltonetworks
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  bandwidth:
    environment:
      RELEASE_NAME: "bandwidth"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_bandwidth
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  stitchfix:
    environment:
      RELEASE_NAME: "stitchfix"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_stitchfix
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  stubhub:
    environment:
      RELEASE_NAME: "stubhub"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_stubhub
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  appsflyer:
    environment:
      RELEASE_NAME: "appsflyer"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_appsflyer
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  intercom:
    environment:
      RELEASE_NAME: "intercom"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_intercom
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  afterpay:
    environment:
      RELEASE_NAME: "afterpay"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_afterpay
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  dremio:
    environment:
      RELEASE_NAME: "dremio"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_dremio
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  caffeine:
    environment:
      RELEASE_NAME: "caffeine"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_caffeine
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  alpha-sense:
    environment:
      RELEASE_NAME: "alpha-sense"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_alpha-sense
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  ytel:
    environment:
      RELEASE_NAME: "ytel"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_ytel
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  aiven:
    environment:
      RELEASE_NAME: "aiven"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_aiven
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  jupiterone:
    environment:
      RELEASE_NAME: "jupiterone"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_jupiterone
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  sadapay:
    environment:
      RELEASE_NAME: "sadapay"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_sadapay
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  glovoapp:
    environment:
      RELEASE_NAME: "glovoapp"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_glovoapp
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  qonto:
    environment:
      RELEASE_NAME: "qonto"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_qonto
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  belcorp:
    environment:
      RELEASE_NAME: "belcorp"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_belcorp
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  color:
    environment:
      RELEASE_NAME: "color"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_color
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  adarga:
    environment:
      RELEASE_NAME: "adarga"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_adarga
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  smartthings:
    environment:
      RELEASE_NAME: "smartthings"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_smartthings
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  load-test:
    environment:
      RELEASE_NAME: "load-test"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_dev-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_dev-us-central1-private-multitenant_load-test
      CLUSTER_ENV: dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  testautomation:
    environment:
      RELEASE_NAME: "testautomation"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_dev-us-central1-private-a
      INSTANCE_VALUES_DIR: gke_dev-us-central1-private-a_testautomation
      CLUSTER_ENV: dev
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.2.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  myfitnesspal:
    environment:
      RELEASE_NAME: "myfitnesspal"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_myfitnesspal
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  benevity:
    environment:
      RELEASE_NAME: "benevity"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_benevity
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  agero:
    environment:
      RELEASE_NAME: "agero"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_agero
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  newrelic:
    environment:
      RELEASE_NAME: "newrelic"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_newrelic
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  sezzle:
    environment:
      RELEASE_NAME: "sezzle"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_sezzle
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  zeotap:
    environment:
      RELEASE_NAME: "zeotap"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_zeotap
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  flymachine:
    environment:
      RELEASE_NAME: "flymachine"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_flymachine
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  coxautoinc:
    environment:
      RELEASE_NAME: "coxautoinc"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_coxautoinc
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  nvidia:
    environment:
      RELEASE_NAME: "nvidia"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_us-central1_prod-us-central1-private-b
      INSTANCE_VALUES_DIR: gke_prod-us-central1-private-b_nvidia
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: us-central1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  europe-test:
    environment:
      RELEASE_NAME: "europe-test"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_europe-west4_prod-europe-west4-private-a
      INSTANCE_VALUES_DIR: gke_prod-europe-west4-private-a_europe-test
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: europe-west4
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private
  asia-test:
    environment:
      RELEASE_NAME: "asia-test"
      KUBE_CLUSTER_ENTRY: gke_blameless-185322_asia-northeast1_prod-asia-northeast1-private-a
      INSTANCE_VALUES_DIR: gke_prod-asia-northeast1-private-a_asia-test
      CLUSTER_ENV: prod
      PROVIDER: gcp
      CLUSTER_REGION: asia-northeast1
      CLUSTER_IP: 172.16.0.2
      CLUSTER_PORT: 1337
    <<: *deploy_private

  # Webhook to Blameless changestream
  # TODO(KMG): Move to separate script
  webhook_to_blameless:
    <<: *default_executor
    steps:
      - run:
          command: |
            echo '{}' | jq '{
               "build_num": env.CIRCLE_BUILD_NUM,
               "branch": env.CIRCLE_BRANCH,
               "username": env.CIRCLE_USERNAME,
               "job": env.CIRCLE_JOB,
               "data": env.CIRCLE_TAG,
               "build_url": env.CIRCLE_BUILD_URL,
               "vcs_revision": env.CIRCLE_SHA1,
               "reponame": env.CIRCLE_PROJECT_REPONAME,
               "workflow_id": env.CIRCLE_WORKFLOW_ID,
               "workflow_url": ("https://circleci.com/workflow-run/" + env.CIRCLE_WORKFLOW_ID),
               "pull_request": env.CI_PULL_REQUEST,
               "user": env.CIRCLE_USERNAME,
               "api_link":("https://circleci.com/api/v1.1/project/" + env.CIRCLE_PROJECT_USERNAME + "/" + env.CIRCLE_PROJECT_REPONAME + "/" + env.CIRCLE_BUILD_NUM),
               "status":"unknown"
             }' > /tmp/raw-webhook.json
          name: Bundle build info into webhook payload
          when: always
      - run:
          command: |
            cat /tmp/raw-webhook.json | jq '.status="success"' > /tmp/webhook.json
            curl -X POST -H"Content-Type:application/json" -d @/tmp/webhook.json $BLAMELESS_CIRCLECI_WEBHOOK || true
          name: Notify Webhook Success with Success Webhook
          when: on_success
      - run:
          command: |-
            cat /tmp/raw-webhook.json | jq '.status="failed"'  > /tmp/webhook.json
            curl -X POST -H"Content-Type:application/json" -d @/tmp/webhook.json $BLAMELESS_CIRCLECI_WEBHOOK || true
          name: Notify Webhook Failure with Failure Webhook
          when: on_fail

###
# Workflow definitions
###
workflows:
  version: 2.1

  deploy_mt_service_to_dev:
    when: << pipeline.parameters.deploy_mt_service_to_dev >>
    jobs:
      - multitenant-service-dev:
          context: ci_builds

  test_and_deploy:
    unless:
      or:
        - << pipeline.parameters.from_api >>
        - << pipeline.parameters.deploy_mt_service_to_dev >>
    jobs:
      # Vallidate version config
      - test_helm_versions:
          context: ci_builds

      # Dev instances
      - blamelesstrial:
          <<: *dev_wf_defaults
      - blamelessdev:
          <<: *dev_wf_defaults
      - testautomation:
          <<: *dev_wf_defaults

      # Holds required for manual approval
      - hold:
          <<: *hold_wf_defaults
      - hold-ha:
          <<: *hold_ha_wf_defaults
      - hold-cre:
          <<: *hold_cre_wf_defaults
      - hold-blameless:
          <<: *hold_blameless_wf_defaults

      # Prod clusters
      - blameless:
          <<: *blameless_wf_defaults
      - blamelesscre:
          <<: *cre_wf_defaults
      - blamelessdemo:
          <<: *prod_wf_defaults
      - checkr:
          <<: *prod_wf_defaults
      - iterable:
          <<: *prod_wf_defaults_ha
      - masterclass:
          <<: *prod_wf_defaults
      - packet:
          <<: *prod_wf_defaults
      - platform9:
          <<: *prod_wf_defaults
      - procore:
          <<: *prod_wf_defaults_ha
      - tenable:
          <<: *prod_wf_defaults_ha
      - homedepot:
          <<: *prod_wf_defaults_ha
      - flywire:
          <<: *prod_wf_defaults_ha
      - underarmour:
          <<: *prod_wf_defaults
      - datarobot:
          <<: *prod_wf_defaults_ha
      - mambu:
          <<: *prod_wf_defaults
      - addepar:
          <<: *prod_wf_defaults
      - earnin:
          <<: *prod_wf_defaults
      - postmates:
          <<: *prod_wf_defaults
      - acs:
          <<: *prod_wf_defaults_ha
      - labelbox:
          <<: *prod_wf_defaults
      - missionlane:
          <<: *prod_wf_defaults
      - vital:
          <<: *prod_wf_defaults_ha
      - citrix:
          <<: *prod_wf_defaults_ha
      - mercari-sandbox:
          <<: *prod_wf_defaults
      - mercari:
          <<: *prod_wf_defaults
      - gojek:
          <<: *prod_wf_defaults
      - allegro:
          <<: *prod_wf_defaults
      - greenlight:
          <<: *prod_wf_defaults
      - gremlin:
          <<: *prod_wf_defaults
      - zapier:
          <<: *prod_wf_defaults_ha
      - inloco:
          <<: *prod_wf_defaults
      - cruise:
          <<: *prod_wf_defaults
      - mux:
          <<: *prod_wf_defaults
      - flatiron:
          <<: *prod_wf_defaults
      - hashicorp:
          <<: *prod_wf_defaults
      - revops:
          <<: *prod_wf_defaults
      - zoopla:
          <<: *prod_wf_defaults
      - fast:
          <<: *prod_wf_defaults
      - hitachisolutions:
          <<: *prod_wf_defaults
      - ticketmaster:
          <<: *prod_wf_defaults
      - fox:
          <<: *prod_wf_defaults
      - eventbrite:
          <<: *prod_wf_defaults
      - demo:
          <<: *prod_wf_defaults
      - crowdstrike:
          <<: *prod_wf_defaults
      - markley:
          <<: *prod_wf_defaults
      - paymentsense:
          <<: *prod_wf_defaults
      - cultureamp:
          <<: *prod_wf_defaults
      - marqeta:
          <<: *prod_wf_defaults
      - twitch:
          <<: *prod_wf_defaults
      - lntinfotech:
          <<: *prod_wf_defaults
      - petalcard:
          <<: *prod_wf_defaults
      - paloaltonetworks:
          <<: *prod_wf_defaults
      - appsflyer:
          <<: *prod_wf_defaults
      - bandwidth:
          <<: *prod_wf_defaults
      - stubhub:
          <<: *prod_wf_defaults
      - stitchfix:
          <<: *prod_wf_defaults
      - intercom:
          <<: *prod_wf_defaults
      - afterpay:
          <<: *prod_wf_defaults
      - dremio:
          <<: *prod_wf_defaults
      - caffeine:
          <<: *prod_wf_defaults
      - alpha-sense:
          <<: *prod_wf_defaults
      - ytel:
          <<: *prod_wf_defaults
      - aiven:
          <<: *prod_wf_defaults
      - jupiterone:
          <<: *prod_wf_defaults
      - sadapay:
          <<: *prod_wf_defaults
      - glovoapp:
          <<: *prod_wf_defaults
      - qonto:
          <<: *prod_wf_defaults
      - color:
          <<: *prod_wf_defaults
      - adarga:
          <<: *prod_wf_defaults
      - smartthings:
          <<: *prod_wf_defaults
      - load-test:
          <<: *prod_wf_defaults
      - belcorp:
          <<: *prod_wf_defaults
      - myfitnesspal:
          <<: *prod_wf_defaults
      - benevity:
          <<: *prod_wf_defaults
      - agero:
          <<: *prod_wf_defaults
      - newrelic:
          <<: *prod_wf_defaults
      - sezzle:
          <<: *prod_wf_defaults
      - zeotap:
          <<: *prod_wf_defaults
      - flymachine:
          <<: *prod_wf_defaults
      - coxautoinc:
          <<: *prod_wf_defaults
      - nvidia:
          <<: *prod_wf_defaults
      - europe-test:
          <<: *prod_wf_defaults
      - asia-test:
          <<: *prod_wf_defaults
